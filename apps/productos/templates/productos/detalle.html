{% extends 'base.html' %}
{% load static %}

{% block title %}{{ producto.nombre }} - Detalle{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/estrellas.css' %}">
<style>
    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 8px;
        font-size: 2rem;
    }
    .rating input { display: none; }
    .rating label { color: #ddd; cursor: pointer; transition: color 0.2s ease; }
    .rating input:checked ~ label, .rating label:hover, .rating label:hover ~ label { color: #ffc107 !important; }
    .calificacion-card { border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .btn-outline-instagram { border-color: #E4405F; color: #E4405F; }
    .btn-outline-instagram:hover { background-color: #E4405F; color: white; }
    .btn-outline-facebook { border-color: #1877F2; color: #1877F2; }
    .btn-outline-facebook:hover { background-color: #1877F2; color: white; }

    /* CARRUSEL GRANDE */
    .carousel-img {
        height: 400px;
        object-fit: cover;
        border-radius: 12px;
    }
    .carousel-control-prev, .carousel-control-next {
        width: 10%;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        opacity: 0.8;
    }
    .carousel-control-prev-icon, .carousel-control-next-icon {
        background-image: none;
        font-family: "bootstrap-icons";
        font-size: 2rem;
        color: white;
    }
    .carousel-control-prev-icon::before { content: "\f284"; }
    .carousel-control-next-icon::before { content: "\f285"; }

    /* ANIMACIONES GLOBALES */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.07); }
    }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-14px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- CARRUSEL GRANDE DE FOTOS (6 MÁXIMO) -->
        <div class="col-md-6">
            <div id="carouselDetalle" class="carousel slide shadow-lg rounded overflow-hidden" data-bs-ride="false">
                <div class="carousel-inner">
                    <!-- FOTO PRINCIPAL -->
                    {% if producto.imagen_principal %}
                        <div class="carousel-item active">
                            <img src="{{ producto.imagen_principal.url }}" class="d-block w-100 carousel-img" alt="{{ producto.nombre }}">
                        </div>
                    {% endif %}

                    <!-- FOTOS ADICIONALES -->
                    {% if producto.imagen_1 %}
                        <div class="carousel-item {% if not producto.imagen_principal %}active{% endif %}">
                            <img src="{{ producto.imagen_1.url }}" class="d-block w-100 carousel-img" alt="">
                        </div>
                    {% endif %}
                    {% if producto.imagen_2 %}
                        <div class="carousel-item">
                            <img src="{{ producto.imagen_2.url }}" class="d-block w-100 carousel-img" alt="">
                        </div>
                    {% endif %}
                    {% if producto.imagen_3 %}
                        <div class="carousel-item">
                            <img src="{{ producto.imagen_3.url }}" class="d-block w-100 carousel-img" alt="">
                        </div>
                    {% endif %}
                    {% if producto.imagen_4 %}
                        <div class="carousel-item">
                            <img src="{{ producto.imagen_4.url }}" class="d-block w-100 carousel-img" alt="">
                        </div>
                    {% endif %}
                    {% if producto.imagen_5 %}
                        <div class="carousel-item">
                            <img src="{{ producto.imagen_5.url }}" class="d-block w-100 carousel-img" alt="">
                        </div>
                    {% endif %}

                    <!-- FOTO ANTIGUA (compatibilidad) -->
                    {% if producto.imagen and not producto.imagen_principal and not producto.imagen_1 and not producto.imagen_2 and not producto.imagen_3 and not producto.imagen_4 and not producto.imagen_5 %}
                        <div class="carousel-item active">
                            <img src="{{ producto.imagen.url }}" class="d-block w-100 carousel-img" alt="{{ producto.nombre }}">
                        </div>
                    {% endif %}

                    <!-- SIN IMAGEN -->
                    {% if not producto.imagen_principal and not producto.imagen_1 and not producto.imagen_2 and not producto.imagen_3 and not producto.imagen_4 and not producto.imagen_5 and not producto.imagen %}
                        <div class="carousel-item active">
                            <div class="bg-light d-flex align-items-center justify-content-center carousel-img">
                                <i class="bi bi-box-seam fs-1 text-muted"></i>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- FLECHAS: SOLO SI HAY MÁS DE 1 FOTO (LÓGICA SIMPLE) -->
                {% if producto.imagen_principal and producto.imagen_1 or producto.imagen_2 or producto.imagen_3 or producto.imagen_4 or producto.imagen_5 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                {% elif producto.imagen_1 and producto.imagen_2 or producto.imagen_3 or producto.imagen_4 or producto.imagen_5 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                {% elif producto.imagen_2 and producto.imagen_3 or producto.imagen_4 or producto.imagen_5 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                {% elif producto.imagen_3 and producto.imagen_4 or producto.imagen_5 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                {% elif producto.imagen_4 and producto.imagen_5 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- INFO + BOTÓN ÉPICO -->
        <div class="col-md-6">
            <div class="p-4">
                <h2 class="fw-bold text-primary">{{ producto.nombre }}</h2>
                {% if producto.es_destacado_activo %}
                    <span class="badge bg-warning text-dark fs-6 mb-2">Destacado</span>
                {% endif %}

                <p class="lead text-dark">{{ producto.descripcion }}</p>

                <ul class="list-group list-group-flush mb-4">
                    {% if producto.categoria %}
                        <li class="list-group-item"><strong>Categoría:</strong> {{ producto.categoria.nombre }}</li>
                    {% endif %}
                    <li class="list-group-item"><strong>Precio:</strong> ${{ producto.precio }}</li>
                    <li class="list-group-item"><strong>Ciudad:</strong> {{ producto.ciudad }}</li>
                    {% if producto.direccion %}
                        <li class="list-group-item"><strong>Dirección:</strong> {{ producto.direccion }}</li>
                    {% endif %}
                </ul>

                <!-- REDES -->
                <div class="mb-4">
                    {% if producto.instagram %}
                        <a href="{{ producto.instagram }}" class="btn btn-outline-instagram me-2" target="_blank">
                            <i class="bi bi-instagram"></i> Instagram
                        </a>
                    {% endif %}
                    {% if producto.facebook %}
                        <a href="{{ producto.facebook }}" class="btn btn-outline-facebook" target="_blank">
                            <i class="bi bi-facebook"></i> Facebook
                        </a>
                    {% endif %}
                </div>

                <!-- DUEÑO -->
                <div class="d-flex align-items-center gap-3 p-3 bg-light rounded mb-4">
                    <img src="{% if producto.propietario.perfil.foto %}{{ producto.propietario.perfil.foto.url }}{% else %}{% static 'img/default-user.png' %}{% endif %}" 
                         class="rounded-circle" width="50" height="50" alt="Vendedor">
                    <div>
                        <strong class="text-primary">Publicado por:</strong><br>
                        <span class="fw-bold text-dark">{{ producto.propietario.username }}</span>
                    </div>
                </div>

                <!-- BOTÓN WHATSAPP ÉPICO -->
                {% if producto.propietario.perfil.whatsapp %}
                <div class="text-center mb-4">
                    <a href="https://wa.me/{{ producto.propietario.perfil.whatsapp|cut:'+' }}?text=¡Hola!%20Vi%20tu%20producto%20{{ producto.nombre|urlencode }}%20en%20Nueva%20Guinea%20y%20lo%20quiero%20comprar"
                       target="_blank"
                       style="
                           display: inline-flex !important;
                           align-items: center !important;
                           justify-content: center !important;
                           gap: 16px !important;
                           background: linear-gradient(45deg, #25D366, #128C7E) !important;
                           border: 6px solid #1DA851 !important;
                           color: white !important;
                           font-weight: bold !important;
                           font-size: 1.7rem !important;
                           padding: 26px 60px !important;
                           border-radius: 80px !important;
                           box-shadow: 0 18px 50px rgba(37,211,102,0.8) !important;
                           text-decoration: none !important;
                           text-transform: uppercase !important;
                           letter-spacing: 2px !important;
                           animation: pulse 2s infinite !important;
                           min-width: 380px !important;
                           text-shadow: 0 3px 6px rgba(0,0,0,0.5) !important;
                           transition: all 0.4s ease !important;
                       "
                       onmouseover="this.style.transform='translateY(-14px) scale(1.12)'; this.style.boxShadow='0 35px 80px rgba(37,211,102,1)'"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 18px 50px rgba(37,211,102,0.8)'">
                        <i class="fab fa-whatsapp" style="font-size: 2.6rem !important; animation: bounce 2s infinite !important;"></i>
                        ¡COMPRAR POR WHATSAPP!
                    </a>
                </div>
                {% else %}
                <div class="text-center mb-4">
                    <button class="btn btn-secondary btn-lg w-100" disabled>
                        <i class="fab fa-whatsapp"></i> Sin WhatsApp
                    </button>
                </div>
                {% endif %}

                <!-- FAVORITO -->
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'productos:favorito' producto.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn {% if es_favorito %}btn-danger{% else %}btn-outline-danger{% endif %} btn-lg w-100">
                        <i class="bi {% if es_favorito %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                        {% if es_favorito %}Quitar{% else %}Agregar{% endif %} a Favoritos
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- CALIFICACIÓN -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow calificacion-card">
                <div class="card-body p-5">
                    <h4 class="text-primary fw-bold mb-4">
                        Calificación del Vendedor: <strong>{{ producto.propietario.username }}</strong>
                    </h4>

                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div>
                            {% with promedio=producto.promedio_calificacion %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= promedio|floatformat:0 %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% elif forloop.counter <= promedio|add:0.5 %}
                                    <i class="bi bi-star-half text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                {% endif %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        <div>
                            <span class="fw-bold fs-4">{{ producto.promedio_calificacion|floatformat:1 }}/5</span>
                            <span class="text-muted small ms-2">({{ producto.total_calificaciones }} calificaciones)</span>
                        </div>
                    </div>

                    {% if user.is_authenticated and user != producto.propietario and not ya_calificado %}
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tu calificación:</label>
                            <div class="rating">
                                <input type="radio" name="puntuacion" value="5" id="prod_star5" required><label for="prod_star5">★</label>
                                <input type="radio" name="puntuacion" value="4" id="prod_star4"><label for="prod_star4">★</label>
                                <input type="radio" name="puntuacion" value="3" id="prod_star3"><label for="prod_star3">★</label>
                                <input type="radio" name="puntuacion" value="2" id="prod_star2"><label for="prod_star2">★</label>
                                <input type="radio" name="puntuacion" value="1" id="prod_star1"><label for="prod_star1">★</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <textarea name="comentario" class="form-control" rows="2" placeholder="Tu opinión (opcional)..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100 shadow">
                            Enviar Calificación
                        </button>
                    </form>
                    {% elif user == producto.propietario %}
                    <p class="text-muted">No puedes calificarte a ti mismo.</p>
                    {% elif ya_calificado %}
                    <p class="text-success">¡Gracias! Ya calificaste.</p>
                    {% else %}
                    <p class="text-muted">
                        <a href="{% url 'usuarios:login' %}?next={{ request.path }}" class="text-primary fw-bold">Inicia sesión</a> para calificar.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rating = document.querySelector('.rating');
        if (!rating) return;

        const labels = rating.querySelectorAll('label');
        labels.forEach(label => {
            label.addEventListener('mouseenter', () => {
                let current = label;
                while (current) {
                    current.style.color = '#ffca2c';
                    current = current.previousElementSibling;
                }
            });
            label.addEventListener('mouseleave', () => {
                if (!document.querySelector(`#${label.htmlFor}`).checked) {
                    let current = label;
                    while (current) {
                        current.style.color = '#ddd';
                        current = current.previousElementSibling;
                    }
                }
            });
        });
    });
</script>
{% endblock %}